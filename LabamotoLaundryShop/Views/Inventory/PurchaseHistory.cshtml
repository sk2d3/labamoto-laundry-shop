@model List<LabamotoLaundryShop.Models.PurchaseOrder>

@{
    Layout = "~/Views/Shared/_OwnerLayout.cshtml";

    // Compute stats
    int totalOrders = Model.Count;
    decimal totalSpent = Model.Sum(x => x.TotalCost);
    int pendingOrders = Model.Count(x => x.Status == "Pending");
    decimal avgOrderValue = totalOrders > 0 ? Model.Average(x => x.TotalCost) : 0;
}

<style>
    .card {
        max-width: 1250px;
        margin: 20px auto;
        padding: 30px 40px;
        background: #ffffff;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }

    .card-body {
        border: 1px solid #e0e7ff;
    }

    .card-header {
        background-color: #ffffff;
        color: #0d6efd;
        font-weight: 600;
        font-size: 18px;
        border: 1px solid #e0e7ff;
    }

    h2 {
        color: #0d6efd;
        font-weight: 600;
        font-size: 25px;
        margin-bottom: 15px;
    }
    

    .table thead {
        background-color: #0d6efd;
        color: white;
    }

    .table tbody tr:hover {
        background-color: rgba(13, 110, 253, 0.1);
    }

    .summary-box {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        border-left: 5px solid #0d6efd;
    }

    .summary-value {
        font-size: 21px;
        
        color: #0d6efd;
    }

    .summary-label {
        font-size: 14px;
        font-weight: 600;
        color: #6c757d;
    }

    custom-link {
        text-decoration: none;
        font-size: 30px;
        color: red;
    }

    .custom-link:hover {
        color: blue; /* color on hover */
    }
</style>





<div class="card shadow-sm border-0 mb-4">
    <!-- Back Button -->
    <div class="mb-3 card-header d-flex justify-content-between align-items-center">
        <span style="font-size: 21px; font-weight: 600;">
            🛒 Purchase Order History
        </span>

        <a href="@Url.Action("Index", "Inventory")" class="custom-link" style="text-decoration: none; color: red; font-size: 30px;">
            &times;
        </a>
    </div>
    
    <div class="card-body" style="padding: 30px 40px;">

        <!-- FILTERS -->
        <!--<div class="row g-3 mb-4">-->
        <!--<div class="col-md-3">
        <label class="form-label fw-bold">Date Range</label>
        <select class="form-select">
            <option>Last 30 Days</option>
            <option>Last 3 Months</option>
            <option>Last 6 Months</option>
            <option>This Year</option>
            <option>All Time</option>
        </select>
    </div>-->

        <form method="get" action="@Url.Action("PurchaseHistory", "Inventory")" class="row g-3" style="margin-bottom: 2rem;">
            <div class="col-12 col-sm-6 col-md-3">
                <label class="form-label fw-bold">Item Category</label>
                <select class="form-select" name="category">
                    <option value="">All Categories</option>
                    @foreach (var cat in Model.Select(x => x.Category).Distinct())
                    {
                        <option value="@cat" @(Request.QueryString["category"] == cat ? "selected" : "")>@cat</option>
                    }
                </select>
            </div>

            <div class="col-12 col-sm-6 col-md-3">
                <label class="form-label fw-bold">Supplier</label>
                <select class="form-select" name="supplier">
                    <option value="">All Suppliers</option>
                    @foreach (var sup in Model.Select(x => x.Supplier).Distinct())
                    {
                        <option value="@sup" @(Request.QueryString["supplier"] == sup ? "selected" : "")>@sup</option>
                    }
                </select>
            </div>

            <div class="col-12 col-sm-6 col-md-3">
                <label class="form-label fw-bold">Status</label>
                <select class="form-select" name="status">
                    <option value="">All Statuses</option>
                    <option value="Pending" @(Request.QueryString["status"] == "Pending" ? "selected" : "")>Pending</option>
                    <option value="Delivered" @(Request.QueryString["status"] == "Delivered" ? "selected" : "")>Delivered</option>
                    <option value="Cancelled" @(Request.QueryString["status"] == "Cancelled" ? "selected" : "")>Cancelled</option>
                </select>
            </div>

            <div class="col-12 col-sm-6 col-md-3 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">Apply Filter</button>
            </div>
        </form>


        <!--</div>-->
        <!-- SUMMARY CARDS -->
        <div class="row g-3" style="margin-bottom: 3rem;">

            <div class="col-md-3">
                <div class="summary-box" style="box-shadow: 0 3px 10px rgba(0,0,0,0.1);">
                    <div class="summary-label">Total Orders</div>
                    <div class="summary-value">@totalOrders</div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="summary-box" style="box-shadow: 0 3px 10px rgba(0,0,0,0.1);">
                    <div class="summary-label">Total Spent</div>
                    <div class="summary-value">₱@totalSpent</div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="summary-box" style="box-shadow: 0 3px 10px rgba(0,0,0,0.1);">
                    <div class="summary-label">Pending Orders</div>
                    <div class="summary-value">@pendingOrders</div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="summary-box" style="box-shadow: 0 3px 10px rgba(0,0,0,0.1);">
                    <div class="summary-label">Avg Order Value</div>
                    <div class="summary-value">₱@avgOrderValue</div>
                </div>
            </div>

        </div>


        <!-- TABLE -->
        <div class="table-responsive">
            <table class="table table-hover align-middle text-center border">
                <thead class="table-light">
                    <tr>
                        <th>PO #</th>
                        <th>Date</th>
                        <th>Item</th>
                        <th>Supplier</th>
                        <th>Quantity</th>
                        <th>Total Cost</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>

                <tbody>
                    @foreach (var po in Model)
                    {
                        <tr>
                            <td>PO-@po.Id</td>
                            <td>@po.CreatedAt.ToString("MMM d")</td>
                            <td>@po.ItemName</td>
                            <td>@po.Supplier</td>
                            <td>@po.OrderQuantity @po.Unit</td>
                            <td>₱@po.TotalCost</td>
                            <td>@po.Status</td>
                            <td>
                                <!-- View Button -->
                                <button type="button" class="btn btn-sm btn-outline-primary"
                                        data-bs-toggle="modal"
                                        data-bs-target="#viewPOModal-@po.Id">
                                    View
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>

            </table>
        </div>

        <!--Modal View-->
        <!-- Modals must be OUTSIDE the table -->
        @foreach (var po in Model)
        {
            <div class="modal fade" id="viewPOModal-@po.Id" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title">Purchase Order Details</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <p><strong>PO #:</strong> @po.Id</p>
                            <p><strong>Date:</strong> @po.CreatedAt.ToString("MMM d, yyyy")</p>
                            <p><strong>Item:</strong> @po.ItemName</p>
                            <p><strong>Supplier:</strong> @po.Supplier</p>
                            <p><strong>Quantity:</strong> @po.OrderQuantity @po.Unit</p>
                            <p><strong>Total Cost:</strong> ₱@po.TotalCost</p>
                            <p>
                                <strong>Status:</strong>
                                <span class="badge
                            @(po.Status == "Pending" ? "bg-warning" :
                              po.Status == "Confirmed" ? "bg-info" :
                              po.Status == "Shipped" ? "bg-primary" :
                              po.Status == "Delivered" ? "bg-success" :
                              po.Status == "Rejected" ? "bg-danger" : "bg-secondary")">
                                    @po.Status
                                </span>
                            </p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- EXPORT + PRINT -->
        <div class="mt-3 text-end">
            <a href="@Url.Action("ExportExcel", "Inventory", new { category = Request.QueryString["category"], supplier = Request.QueryString["supplier"], status = Request.QueryString["status"] })"
               class="btn btn-outline-success">
                📥 Export to Excel
            </a>
            <button type="button" onclick="window.print()" class="btn btn-outline-dark">🖨️ Print Report</button>
       
    </div>

    </div>
</div>
