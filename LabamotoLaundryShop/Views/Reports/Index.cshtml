@{
    ViewBag.Title = "Reports & Analytics";
    Layout = "~/Views/Shared/_OwnerLayout.cshtml";
    var orders = ViewBag.Orders as List<LabamotoLaundryShop.Models.Order> ?? new List<LabamotoLaundryShop.Models.Order>();
    var incomeData = ViewBag.IncomeData as Dictionary<string, decimal> ?? new Dictionary<string, decimal>();
    var startDate = ViewBag.StartDate ?? DateTime.Today.AddDays(-7).ToString("yyyy-MM-dd");
    var endDate = ViewBag.EndDate ?? DateTime.Today.ToString("yyyy-MM-dd");
}

<style>
    .report-container {
        max-width: 1250px;
        margin: 20px auto;
        padding: 30px 40px;
        background: #ffffff;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }

        .report-container h2 {
            color: #0d6efd;
            font-weight: 600;
            margin-bottom: 20px;
            font-size: 25px;
        }

    .section-card {
        background: #ffffff;
        border: 1px solid #e0e7ff;
        border-radius: 10px;
        padding: 25px 30px;
        margin-bottom: 25px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

        .section-card h5, .section-card h4 {
            font-weight: 600;
            color: #475569;
            margin-bottom: 15px;
        }

    .stats-cards {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 20px;
    }

        .stats-cards .card {
            flex: 1;
            min-width: 180px;
            padding: 25px;
            border: none;
            text-align: center;
            border-radius: 12px;
            background: #ffffff;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transition: 0.2s;
        }

            .stats-cards .card:hover {
                transform: translateY(-5px);
                box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            }

            .stats-cards .card h5 {
                font-size: 16px;
                color: #0B64E5;
                margin-bottom: 8px;
            }

            .stats-cards .card p {
                font-size: 26px;
                color: #000000;
                margin: 0;
            }
</style>

<div class="report-container">

    <a href="@Url.Action("Dashboard", "Owner")" class="btn btn-outline-secondary mb-3">← Back</a>
    <h2>📊 Reports & Analytics</h2>

    <!-- Date Filter -->
    <div class="section-card">
        <h5>Date Range</h5>
        <form method="get" action="">
            <div class="row g-2">
                <div class="col-md-4">
                    <label>From:</label>
                    <input type="date" name="startDate" class="form-control" value="@startDate" />
                </div>
                <div class="col-md-4">
                    <label>To:</label>
                    <input type="date" name="endDate" class="form-control" value="@endDate" />
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">Apply Filter</button>
                </div>
            </div>
        </form>
    </div>

    <!-- Stats Cards -->
    <div class="stats-cards">
        <div class="card">
            <h5>Total Orders</h5>
            <p>@orders.Count</p>
        </div>
        <div class="card">
            <h5>Today's Orders</h5>
            <p>@orders.Count(o => o.OrderDate.Date == DateTime.Today)</p>
        </div>
        <div class="card">
            <h5>Active Orders</h5>
            <p>@orders.Count(o => o.Status != "Completed")</p>
        </div>
        <div class="card">
            <h5>Total Income</h5>
            <p>₱@orders.Sum(o => o.TotalAmount).ToString("N2")</p>
        </div>
    </div>

    <!-- Income Chart -->
    <div class="section-card">
        <h4>Income Over Time</h4>
        <canvas id="incomeChart" height="120"></canvas>
    </div>

    <!-- Transaction History -->
    <div class="section-card">
        <h4>Transaction History</h4>
        <div class="table-responsive">
            <table class="table table-striped align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Date</th>
                        <th>Order ID</th>
                        <th>Customer</th>
                        <th>Amount</th>
                        
                    </tr>
                </thead>
                <tbody>
                    @foreach (var order in orders.OrderByDescending(o => o.OrderDate))
                    {
                        <tr>
                            <td>@order.OrderDate.ToString("yyyy-MM-dd")</td>
                            <td>#@order.OrderID</td>
                            <td>@order.CustomerID</td>
                            <td>₱@order.TotalAmount.ToString("N2")</td>
                            
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const ctx = document.getElementById('incomeChart').getContext('2d');
    const labels = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(incomeData.Keys));
    const data = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(incomeData.Values));

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: "Income",
                data: data,
                borderWidth: 3,
                tension: 0.3,
                borderColor: '#0a58ca',
                backgroundColor: 'rgba(10, 88, 202, 0.15)'
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { callback: function(v){ return '₱' + v.toLocaleString(); } }
                }
            }
        }
    });
</script>
